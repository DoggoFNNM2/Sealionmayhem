<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>THE FINAL RECKONING</title>
    <style>
        :root { 
            --wobble: 0deg; 
            --drift-x: 0px; 
            --drift-y: 0px;
            --headache: 0;
        }

        body, html {
            margin: 0; padding: 0; width: 100vw; height: 100vh;
            background: #1a001a; overflow: hidden;
        }

        /* AGGRESSIVE CHROMATIC ABERRATION */
        .drunk-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 1; mix-blend-mode: exclusion;
        }

        .red-shift { 
            background: rgba(255, 0, 0, 0.2); 
            transform: translate(var(--drift-x), var(--drift-y)) rotate(var(--wobble)); 
        }
        .blue-shift { 
            background: rgba(0, 255, 255, 0.2); 
            transform: translate(calc(var(--drift-x) * -2), calc(var(--drift-y) * -2)) rotate(calc(var(--wobble) * -1.5)); 
        }

        /* HEADACHE THROB (Triggers after 100s) */
        .headache-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 20%, rgba(120, 0, 0, var(--headache)) 100%);
            z-index: 15; pointer-events: none;
            backdrop-filter: saturate(calc(1 + var(--headache) * 5));
        }

        .post-processing {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            backdrop-filter: blur(5px);
            mask-image: radial-gradient(circle, transparent 10%, black 90%);
            z-index: 10; pointer-events: none;
        }

        canvas { z-index: 5; position: relative; }

        #start-button {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            padding: 40px; background: #ff00ea; color: white; font-weight: bold;
            font-family: 'Impact'; font-size: 2.5rem; z-index: 10000;
            cursor: pointer; border: 5px solid white;
        }
    </style>
</head>
<body>
    <div class="headache-overlay"></div>
    <div class="drunk-layer red-shift"></div>
    <div class="drunk-layer blue-shift"></div>
    <div class="post-processing"></div>

    <button id="start-button">DRINK THE FORBIDDEN MILK</button>

    <script type="module">
        import * as THREE from 'https://unpkg.com/three@0.147.0/build/three.module.js';

        let scene, camera, renderer, swarm = [], hallucinations = [], floor;
        let time = 0;
        let startTime = Date.now();

        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(125, window.innerWidth / window.innerHeight, 0.01, 50);
            
            renderer = new THREE.WebGLRenderer({ antialias: false, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            document.body.appendChild(renderer.domElement);

            const texture = new THREE.TextureLoader().load('sealion.png');

            // 1. THE OPAQUE WAVY FLOOR
            const floorGeo = new THREE.PlaneGeometry(30, 30, 64, 64);
            const floorMat = new THREE.MeshBasicMaterial({ 
                map: texture, 
                side: THREE.DoubleSide,
                color: 0x888888
            });
            floor = new THREE.Mesh(floorGeo, floorMat);
            floor.rotation.x = -Math.PI / 2;
            floor.position.y = -1.5;
            scene.add(floor);

            // 2. THE FLOATING MENTAL BREAKDOWN (3D Objects)
            for (let i = 0; i < 60; i++) {
                const geo = new THREE.TorusGeometry(Math.random(), 0.1, 16, 100);
                const mat = new THREE.MeshNormalMaterial({ wireframe: true });
                const mesh = new THREE.Mesh(geo, mat);
                mesh.position.set((Math.random()-0.5)*20, (Math.random()-0.5)*20, (Math.random()-0.5)*20);
                scene.add(mesh);
                hallucinations.push(mesh);
            }

            // 3. SEA LIONS (The only clear part of your nightmare)
            for (let i = 0; i < 100; i++) {
                const mat = new THREE.SpriteMaterial({ map: texture });
                const s = new THREE.Sprite(mat);
                s.position.set((Math.random()-0.5)*12, (Math.random()-0.5)*12, (Math.random()-0.5)*12);
                s.scale.set(0.5, 0.5, 1);
                scene.add(s);
                swarm.push(s);
            }

            const btn = document.getElementById('start-button');
            btn.addEventListener('click', () => {
                navigator.xr.requestSession('immersive-ar', {
                    requiredFeatures: ['local-floor'],
                    optionalFeatures: ['dom-overlay'],
                    domOverlay: { root: document.body }
                }).then(session => {
                    renderer.xr.setSession(session);
                    btn.style.display = 'none';
                    startTime = Date.now();
                });
            });

            renderer.setAnimationLoop(() => {
                time += 0.04;
                const elapsed = (Date.now() - startTime) / 1000;

                // 1. HEADACHE ENGINE (Starts after 100s)
                if (elapsed > 10) {
                    const throb = Math.abs(Math.sin(time * 2));
                    document.documentElement.style.setProperty('--headache', throb * 0.6);
                }

                // 2. DRUNKEN INERTIA (Camera can't stay still)
                camera.position.x += Math.sin(time * 0.5) * 0.05;
                camera.position.z += Math.cos(time * 0.3) * 0.05;
                camera.rotation.y += Math.sin(time * 0.2) * 0.02;
                camera.rotation.z = Math.sin(time * 0.8) * 0.2;
                camera.fov = 110 + Math.sin(time) * 30;
                camera.updateProjectionMatrix();

                // 3. CSS CHAOS
                document.documentElement.style.setProperty('--drift-x', `${Math.sin(time * 2) * 40}px`);
                document.documentElement.style.setProperty('--drift-y', `${Math.cos(time * 1.5) * 40}px`);
                document.documentElement.style.setProperty('--wobble', `${Math.sin(time) * 10}deg`);

                // 4. THE WAVE FLOOR (Opaque & Violent)
                const pos = floor.geometry.attributes.position;
                for (let i = 0; i < pos.count; i++) {
                    const x = pos.getX(i);
                    const y = pos.getY(i);
                    const wave = Math.sin(x + time) * 0.8 + Math.cos(y + time) * 0.8;
                    pos.setZ(i, wave);
                }
                pos.needsUpdate = true;

                renderer.render(scene, camera);
            });
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>
