<!DOCTYPE html>
<html>
<head>
    <title>TERMINATOR_HUD_STATIC_v1.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script async src="https://docs.opencv.org/4.5.4/opencv.js" type="text/javascript"></script>
    <style>
        body { margin: 0; background: #000; color: #f00; font-family: 'Courier New', monospace; overflow: hidden; }
        #ui-layer { position: absolute; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; pointer-events: none; }
        #canvasOutput { width: 80%; border: 2px solid #f00; box-shadow: 0 0 20px #f00; filter: sepia(100%) saturate(300%) hue-rotate(-50deg); }
        .hud-text { position: absolute; top: 5%; left: 5%; font-size: 1.2em; text-transform: uppercase; animation: blink 1s infinite; }
        #vr-btn-container { position: absolute; bottom: 5%; z-index: 20; pointer-events: auto; }
        video { display: none; }
    </style>
</head>
<body>
    <video id="videoInput" playsinline autoplay></video>
    
    <div id="ui-layer">
        <div class="hud-text">
            STATUS: ANALYZING_ENVIRONMENT...<br>
            OBJ_DETECTION: LASER_TRIANGULATION<br>
            POINTS_SYNCED: <span id="pt-count">0</span>
        </div>
        <canvas id="canvasOutput"></canvas>
        <div id="vr-btn-container"></div>
    </div>

    <script type="module">
        import { VRButton } from 'https://cdn.skypack.dev/three@0.128.0/examples/jsm/webxr/VRButton.js';

        // --- CONFIG ---
        const H_OFFSET = 12.0; 
        const RPC = 0.0016;
        const MAX_POINTS = 50000;

        let scene, camera, renderer, points, pointIdx = 0;
        let video = document.getElementById('videoInput');
        let src, dst, hsv, mask;

        // --- THREE.JS SETUP ---
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        document.getElementById('vr-btn-container').appendChild(VRButton.createButton(renderer));

        const grid = new THREE.GridHelper(400, 80, 0xff0000, 0x220000);
        grid.position.y = -20;
        scene.add(grid);

        const geo = new THREE.BufferGeometry();
        geo.setAttribute('position', new THREE.BufferAttribute(new Float32Array(MAX_POINTS * 3), 3));
        const mat = new THREE.PointsMaterial({ color: 0xff0000, size: 0.15 });
        points = new THREE.Points(geo, mat);
        scene.add(points);

        // --- OPENCV / WEBCAM LOGIC ---
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false })
            .then(stream => { video.srcObject = stream; video.play(); });

        window.onload = () => {
            cv['onRuntimeInitialized'] = () => {
                src = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC4);
                dst = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC1);
                hsv = new cv.Mat();
                mask = new cv.Mat();
                processVideo();
            };
        };

        function processVideo() {
            try {
                let cap = new cv.VideoCapture(video);
                cap.read(src);

                // Laser Detection
                cv.cvtColor(src, hsv, cv.COLOR_RGBA2RGB);
                cv.cvtColor(hsv, hsv, cv.COLOR_RGB2HSV);
                
                // Mask for bright laser (adjust values if needed)
                let low = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [0, 0, 240, 0]);
                let high = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [180, 50, 255, 0]);
                cv.inRange(hsv, low, high, mask);

                let moments = cv.moments(mask, false);
                if (moments.m00 > 5) {
                    let cx = moments.m10 / moments.m00;
                    let cy = moments.m01 / moments.m00;
                    
                    let pixel_offset = cx - (src.cols / 2);
                    if (Math.abs(pixel_offset) > 2) {
                        let dist = H_OFFSET / Math.tan(Math.abs(pixel_offset) * RPC);
                        
                        // Add to 3D Scene
                        const pos = points.geometry.attributes.position.array;
                        pos[pointIdx * 3] = (pixel_offset * (dist / 300)) / 5;
                        pos[pointIdx * 3 + 1] = ((src.rows/2 - cy) * (dist / 300)) / 5;
                        pos[pointIdx * 3 + 2] = (-dist) / 5;
                        
                        pointIdx = (pointIdx + 1) % MAX_POINTS;
                        points.geometry.attributes.position.needsUpdate = true;
                        document.getElementById('pt-count').innerText = pointIdx;
                    }
                }

                // HUD Visual Effect (Scanlines)
                cv.imshow('canvasOutput', mask); // Shows the laser detection "Vision"
                
                low.delete(); high.delete();
                requestAnimationFrame(processVideo);
            } catch (err) {
                setTimeout(processVideo, 1000);
            }
        }

        renderer.setAnimationLoop(() => { renderer.render(scene, camera); });
    </script>
</body>
</html>
